
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>CanCanCan Cheatsheet - Key Shift in Cmd</title>
  <meta name="author" content="Aleck Greenham">

  
  <meta name="description" content="CanCanCan Cheatsheet written A breakdown of how to define and check abilities with CanCanCan, with an opinionated set of best practices based on &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://greena13.github.io/blog/2019/07/12/cancancan-cheatsheet">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Key Shift in Cmd" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-55678102-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

  <body>
    <a href="/" class="home-icon">
      <img src="/images/home.png"/>
    </a>

    <article role="article" class="full-single-article">
  <div class="container">
    <div class="row">
      <div class="col-md-8 col-md-offset-2">
        <h1>CanCanCan Cheatsheet</h1>
        <div class="meta">
          written 








  



<time datetime="2019-07-12T08:14:48+01:00" pubdate data-updated="true"></time>
          


        </div>
        <p>A breakdown of how to define and check abilities with CanCanCan, with an opinionated set of best practices based on experience.</p>

<!--more-->


<h2>Defining abilities</h2>

<h3>General Best practices</h3>

<h4>No access by default</h4>

<p>Give abilities as you discover you need them</p>

<ul>
<li>Don’t define them upfront because you think you’ll need them</li>
<li>Always use can? to enable a feature - never use cannot? to take it away</li>
</ul>


<p>Only use the standard <code>index</code>, <code>show</code>, <code>create</code>, <code>update</code>, <code>destroy</code> (edit is subset of updated and new is a subset of create)</p>

<h4>Your ability file is not somewhere to be DRY; being explicit and clear</h4>

<p>Don’t use <code>manage</code> (its too permissive)</p>

<p>Don’t define aliases - always be explicit and granular:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Bad</span>
</span><span class='line'><span class="n">alias_action</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:read</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="p">,</span> <span class="ss">to</span><span class="p">:</span> <span class="ss">:crud</span>
</span><span class='line'><span class="n">can</span> <span class="ss">:crud</span><span class="p">,</span> <span class="no">User</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Good</span>
</span><span class='line'><span class="n">can</span> <span class="o">[</span><span class="ss">:create</span><span class="p">,</span> <span class="ss">:read</span><span class="p">,</span> <span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span><span class="p">,</span> <span class="no">User</span>
</span></code></pre></td></tr></table></div></figure>


<p>Define permissions for one resource at a time.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Bad: Update or destroy both articles and comments</span>
</span><span class='line'><span class="n">can</span> <span class="o">[</span><span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span><span class="p">,</span> <span class="o">[</span><span class="no">Article</span><span class="p">,</span> <span class="no">Comment</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Good</span>
</span><span class='line'><span class="n">can</span> <span class="o">[</span><span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span><span class="p">,</span> <span class="no">Article</span>
</span><span class='line'><span class="n">can</span> <span class="o">[</span><span class="ss">:update</span><span class="p">,</span> <span class="ss">:destroy</span><span class="o">]</span><span class="p">,</span> <span class="no">Comment</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Syntax</h3>

<h4>Hash Conditions</h4>

<p>Preferred syntax (used most consistently without hidden side-effects between all 3 methods)
* can? &amp; authorize!: Keys match methods on instance, which must return values equal to the hash&rsquo;s values
* accessible_by: Generates a LEFT JOIN to query conditions on associated records (so almost anything you can pass to a hash of conditions in Active Record will work)</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">can</span> <span class="ss">:read</span><span class="p">,</span> <span class="no">Project</span><span class="p">,</span> <span class="ss">active</span><span class="p">:</span> <span class="kp">true</span><span class="p">,</span> <span class="ss">user_id</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span>
</span></code></pre></td></tr></table></div></figure>


<p>Can’t pass model instances into the hash - you must use their id instead:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># Won’t work</span>
</span><span class='line'><span class="n">can</span> <span class="ss">:manage</span><span class="p">,</span> <span class="no">Project</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">groups</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Will work</span>
</span><span class='line'><span class="n">can</span> <span class="ss">:manage</span><span class="p">,</span> <span class="no">Project</span><span class="p">,</span> <span class="ss">group</span><span class="p">:</span> <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">group_ids</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Must use lower-level attributes rather than your existing scopes that wrap them:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">can</span> <span class="ss">:read</span><span class="p">,</span> <span class="no">Article</span><span class="p">,</span> <span class="ss">is_published</span><span class="p">:</span> <span class="kp">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>Can use a range:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">can</span> <span class="ss">:read</span><span class="p">,</span> <span class="no">Project</span><span class="p">,</span> <span class="ss">priority</span><span class="p">:</span> <span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="mi">3</span>
</span></code></pre></td></tr></table></div></figure>


<p>Defining conditions on associations:
* Will issue a query that performs an <code>LEFT JOIN</code> to query conditions on associated records</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">can</span> <span class="ss">:read</span><span class="p">,</span> <span class="no">Project</span><span class="p">,</span> <span class="ss">category</span><span class="p">:</span> <span class="p">{</span> <span class="ss">visible</span><span class="p">:</span> <span class="kp">true</span> <span class="p">}</span>
</span><span class='line'><span class="n">can</span> <span class="ss">:manage</span><span class="p">,</span> <span class="no">Part</span><span class="p">,</span> <span class="ss">service</span><span class="p">:</span> <span class="p">{</span> <span class="ss">account</span><span class="p">:</span> <span class="p">{</span> <span class="ss">user</span><span class="p">:</span> <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Blocks</h4>

<p>Use only if you need to pass additional context or can’t express the logic using hashes:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">can</span> <span class="ss">:create</span><span class="p">,</span> <span class="no">Project</span> <span class="k">do</span> <span class="o">|</span><span class="n">project</span><span class="p">,</span> <span class="n">remote_ip</span><span class="o">|</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">can?</span> <span class="ss">:create</span><span class="p">,</span> <span class="no">Project</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_ip</span>
</span></code></pre></td></tr></table></div></figure>


<p>Only evaluated when an actual instance object is present</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">can</span> <span class="ss">:update</span><span class="p">,</span> <span class="no">Project</span> <span class="k">do</span> <span class="o">|</span><span class="n">project</span><span class="o">|</span>
</span><span class='line'>  <span class="n">project</span><span class="o">.</span><span class="n">priority</span> <span class="o">&lt;</span> <span class="mi">3</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Scopes &amp; Raw SQL</h4>

<p>If you need an operator other than the equality one, or for other complex cases, you can provide a scope or a Raw SQL segment.</p>

<p>You must <strong>always also define a block</strong>, or you get an error:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">can</span> <span class="ss">:read</span><span class="p">,</span> <span class="no">Article</span><span class="p">,</span> <span class="no">Article</span><span class="o">.</span><span class="n">published_recently</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Raises exception:</span>
</span><span class='line'><span class="c1"># The can? and cannot? call cannot be used with a raw sql &#39;can&#39; definition.</span>
</span><span class='line'><span class="c1"># The checking code cannot be determined for :read #&lt;Article ..&gt;.</span>
</span><span class='line'><span class="n">can?</span> <span class="ss">:read</span><span class="p">,</span> <span class="no">Article</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>When you also define a block:</p>

<ul>
<li>Block is used when <code>can?</code> and <code>authorize!</code> are passed an instance</li>
<li>Scope or Raw SQL segment is use when <code>accessible_by</code> is called</li>
<li>Neither are used when when <code>can?</code> and <code>authorize!</code> are passed a class (only matches on action and class type)</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">can</span> <span class="ss">:read</span><span class="p">,</span> <span class="no">Article</span><span class="p">,</span> <span class="no">Article</span><span class="o">.</span><span class="n">published_recently</span> <span class="k">do</span> <span class="o">|</span><span class="n">article</span><span class="o">|</span>
</span><span class='line'>  <span class="n">article</span><span class="o">.</span><span class="n">created_at</span> <span class="o">&gt;</span> <span class="no">DateTime</span><span class="o">.</span><span class="n">now</span> <span class="o">-</span> <span class="mi">3</span><span class="o">.</span><span class="n">days</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Works fine</span>
</span><span class='line'><span class="n">can?</span> <span class="ss">:read</span><span class="p">,</span> <span class="no">Article</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using a SQL segment:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">can</span> <span class="ss">:update</span><span class="p">,</span> <span class="no">Project</span><span class="p">,</span> <span class="o">[</span><span class="s2">&quot;priority &lt; ?&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="o">]</span> <span class="k">do</span> <span class="o">|</span><span class="n">project</span><span class="o">|</span>
</span><span class='line'>  <span class="n">project</span><span class="o">.</span><span class="n">priority</span> <span class="o">&lt;</span> <span class="mi">3</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Operators</h4>

<table style="border-collapse: collapse; min-width: 100%;">
    <colgroup>
        <col style="width: 62px;"/>
        <col style="width: 274px;"/>
        <col style="width: 294px;"/>
        <col style="width: 93px;"/>
        <col style="width: 88px;"/>
    </colgroup>
    <tbody>
    <tr>
        <td rowspan="2" style="height: 56px; width: 62px; padding: 8px; border: 1px solid;">
            <div>Operator</div>
        </td>
        <td rowspan="2" style="height: 56px; width: 274px; padding: 8px; border: 1px solid;">
            <div>Actions</div>
        </td>
        <td colspan="3" style="width: 475px; padding: 8px; border: 1px solid;">
            <div>Conditions</div>
        </td>
    </tr>
    <tr>
        <td style="border: 1px solid; width: 294px; padding: 8px;">
            <div>Hash</div>
        </td>
        <td style="width: 93px; padding: 8px; border: 1px solid;">
            <div>Block</div>
        </td>
        <td style="width: 88px; padding: 8px; border: 1px solid;">
            <div>Raw SWL</div>
        </td>
    </tr>
    <tr>
        <td style="width: 62px; padding: 8px; border: 1px solid;">
            <div>AND</div>
        </td>
        <td style="width: 274px; padding: 8px; border: 1px solid;">
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>can <font style="color: rgb(255, 38, 0); --inversion-type-color: simple;">[</font>:show<font
                        style="color: rgb(255, 38, 0); --inversion-type-color: simple;">,</font>
                    :index<font style="color: rgb(255, 38, 0); --inversion-type-color: simple;">]</font>
                </div>
            </div>
            <div/>
        </td>
        <td style="width: 294px; padding: 8px; border: 1px solid;">
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>can :read, Article, <span
                        style="color: rgb(255, 38, 0); --inversion-type-color: simple;">author_id: @user.id, is_published: false</span><br/>
                </div>
                <div><br clear="none"/></div>
                <div>WHERE ( `articles`.`author_id` = 97 AND `articles`.`is_published` = 0 )</div>
            </div>
        </td>
        <td rowspan="3" style="height: 92px; width: 93px; padding: 8px; border: 1px solid;">
            <div>Normal Ruby syntax</div>
            <div/>
        </td>
        <td rowspan="3" style="height: 92px; width: 88px; padding: 8px; border: 1px solid;">
            <div>Normal SQL syntax</div>
            <div/>
        </td>
    </tr>
    <tr>
        <td style="width: 62px; padding: 8px; border: 1px solid;">
            <div>OR</div>
        </td>
        <td style="width: 274px; padding: 8px; border: 1px solid;">
            <div>Read released or preview:</div>
            <div><br clear="none"/></div>
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>can :read, Project, released: true</div>
                <div><font style="color: rgb(255, 38, 0); --inversion-type-color: simple;">can :read,
                    Project, preview: true</font></div>
            </div>
            <div/>
        </td>
        <td rowspan="2" style="height: 56px; width: 294px; padding: 8px; border: 1px solid;">
            <div>Not possible</div>
            <div/>
        </td>
    </tr>
    <tr>
        <td style="width: 62px; padding: 8px; border: 1px solid;">
            <div>NOT</div>
        </td>
        <td style="width: 274px; padding: 8px; border: 1px solid;">
            <div>Not recommended - always give abilities, don’t take them away</div>
            <div><br/></div>
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div><font style="color: rgb(255, 38, 0); --inversion-type-color: simple;">cannot</font>
                    :destroy, Project
                </div>
            </div>
            <div/>
        </td>
    </tr>
    <tr>
        <td style="width: 62px; padding: 8px; border: 1px solid;">
            <div>Precedence</div>
        </td>
        <td style="width: 274px; padding: 8px; border: 1px solid;">
            <div>An ability rule will override a previous one:</div>
            
            <div>
                <span>If they were reversed,</span>
                <span>cannot :destroy</span>
                <span> would be overridden by </span>
                <span>can :manage</span>
                <span>.</span>
            </div>
                                        
            <div/>
            <div><br clear="none"/></div>
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>can :manage, Project</div>
                <div>cannot :destroy, Project</div>
            </div>
            <div/>
        </td>
        <td style="width: 294px; padding: 8px; border: 1px solid;">
            <div>Equal</div>
            <div/>
        </td>
        <td style="width: 93px; padding: 8px; border: 1px solid;">
            <div>Normal Ruby precedence</div>
        </td>
        <td style="width: 88px; padding: 8px; border: 1px solid;">
            <div>Depends on your database</div>
        </td>
    </tr>
    </tbody>
</table>


<h4>Defining custom logic</h4>

<p>Useful when permissions are defined outside of Ruby such as when defining Abilities in Database
* Block will be triggered for every <code>can?</code> check, even when only a class is used in the check.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">can</span> <span class="k">do</span> <span class="o">|</span><span class="n">action</span><span class="p">,</span> <span class="n">subject_class</span><span class="p">,</span> <span class="n">subject</span><span class="o">|</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Merging ability files</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># ApplicationController.rb</span>
</span><span class='line'><span class="k">def</span> <span class="nf">current_ability</span>
</span><span class='line'>  <span class="vi">@current_ability</span> <span class="o">||=</span> <span class="no">ReadAbility</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">current_user</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="no">WriteAbility</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">current_user</span><span class="p">))</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Checking abilities</h2>

<h3>General best practices</h3>

<p>Never use <code>load_and_authorize_resource</code> or <code>load_resource</code>, instead use the more explicit <code>authorize!</code> call for readability and flexibiltiy</p>

<p>Use <code>check_authorization</code> to ensure all controller actions are authorized:
* Adds an <code>after_filter</code> to ensure <code>authorize!</code> is called for every controller action</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">check_authorization</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">skip_authorization_check</span> <span class="ss">:only</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:new</span><span class="p">,</span> <span class="ss">:create</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">check_authorization</span> <span class="k">unless</span><span class="p">:</span> <span class="ss">:admin_subdomain?</span> <span class="c1"># Only skips checking authorization - still does the authorization</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">admin_subdomain?</span>
</span><span class='line'>    <span class="n">request</span><span class="o">.</span><span class="n">subdomain</span> <span class="o">==</span> <span class="s2">&quot;admin&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>CanCanCan methods</h3>

<p>There are 3 methods for checking a user&rsquo;s abilities:</p>

<table style="border-collapse: collapse; min-width: 100%;">
    <colgroup>
        <col style="width: 122px;"/>
        <col style="width: 227px;"/>
        <col style="width: 205px;"/>
        <col style="width: 250px;"/>
    </colgroup>
    <tbody>
    <tr>
        <td rowspan="1" style="width: 122px; padding: 8px; border: 1px solid;">
            <div><br/></div>
        </td>
        <td style="width: 227px; padding: 8px; border: 1px solid;">
            <div><span style="font-family: &quot;Courier New&quot;;">can?</span></div>
        </td>
        <td rowspan="1" style="width: 205px; padding: 8px; border: 1px solid;">
            <div><span style="font-family: &quot;Courier New&quot;;">authorize!</span></div>
        </td>
        <td rowspan="1" style="width: 250px; padding: 8px; border: 1px solid;">
            <div><span style="font-family: &quot;Courier New&quot;;">accessible_by</span></div>
        </td>
    </tr>
    <tr>
        <td rowspan="1" style="width: 122px; padding: 8px; border: 1px solid;">
            <div>For</div>
        </td>
        <td colspan="2" style="width: 432px; padding: 8px; border: 1px solid;">
            <div>Checking user has ability to do an action on a resource</div>
        </td>
        <td rowspan="1" style="width: 250px; padding: 8px; border: 1px solid;">
            <div>Filtering a collection down to those resources a user has the ability to perform an action on
                (Default: <span style="font-family: &quot;Courier New&quot;;">:index</span>)
            </div>
        </td>
    </tr>
    <tr>
        <td rowspan="1" style="width: 122px; padding: 8px; border: 1px solid;">
            <div>Input</div>
        </td>
        <td colspan="2" style="width: 432px; padding: 8px; border: 1px solid;">
            <div><span style="font-family: &quot;Courier New&quot;;">(action, class|instance[, additional_block_args])</span>
            </div>
        </td>
        <td rowspan="1" style="width: 250px; padding: 8px; border: 1px solid;">
            <div><span style="font-family: &quot;Courier New&quot;;">accessible_by(current_ability[, action = :index])</span>
            </div>
        </td>
    </tr>
    <tr>
        <td rowspan="1" style="width: 122px; padding: 8px; border: 1px solid;">
            <div>Output</div>
        </td>
        <td style="width: 227px; padding: 8px; border: 1px solid;">
            <div><span style="font-family: &quot;Helvetica Neue&quot;;">Returns</span><span
                    style="font-family: &quot;Courier New&quot;;"> true/false</span></div>
        </td>
        <td rowspan="1" style="width: 205px; padding: 8px; border: 1px solid;">
            <div>Throws <span style="font-family: &quot;Courier New&quot;;">CanCan::AccessDenied</span>
                exception
            </div>
        </td>
        <td rowspan="1" style="width: 250px; padding: 8px; border: 1px solid;">
            <div>Returns scoped collection</div>
        </td>
    </tr>
    <tr>
        <td rowspan="1" style="width: 122px; padding: 8px; border: 1px solid;">
            <div>Application</div>
        </td>
        <td style="width: 227px; padding: 8px; border: 1px solid;">
            <div><span
                    style="font-family: &quot;Helvetica Neue&quot;;">Views (for toggling UI elements)</span>
            </div>
        </td>
        <td rowspan="1" style="width: 205px; padding: 8px; border: 1px solid;">
            <div>Controller actions (for rescuing exceptions and rendering unauthorized)</div>
        </td>
        <td rowspan="1" style="width: 250px; padding: 8px; border: 1px solid;">
            <div><span style="font-family: &quot;Courier New&quot;;">index</span> action for filtering
                resources list
            </div>
            <div><br clear="none"/></div>
            <div>Elsewhere for filtering associations</div>
        </td>
    </tr>
    </tbody>
</table>


<p>Abilities are matched on up to 3 different attributes:</p>

<ul>
<li>An action type</li>
<li>A target or subject class</li>
<li>A set of conditions (optional, if defined)</li>
</ul>


<table style="border-collapse: collapse; min-width: 100%;">
    <colgroup>
        <col style="width: 111px;"/>
        <col style="width: 77px;"/>
        <col style="width: 73px;"/>
        <col style="width: 114px;"/>
        <col style="width: 156px;"/>
        <col style="width: 288px;"/>
    </colgroup>
    <tbody>
    <tr>
        <td style="width: 111px; padding: 8px; border: 1px solid;">
            <div><br/></div>
        </td>
        <td style="width: 77px; padding: 8px; border: 1px solid;">
            <div>Required for Definition</div>
        </td>
        <td colspan="4" style="width: 631px; padding: 8px; border: 1px solid;">
            <div>Required to match for check to pass</div>
        </td>
    </tr>
    <tr>
        <td style="width: 111px; padding: 8px; border: 1px solid;">
            <div>Action Type</div>
        </td>
        <td style="width: 77px; padding: 8px; border: 1px solid;">
            <div>Yes</div>
        </td>
        <td colspan="4" style="width: 631px; padding: 8px; border: 1px solid;">
            <div>Always</div>
        </td>
    </tr>
    <tr>
        <td style="width: 111px; padding: 8px; border: 1px solid;">
            <div>Target or Subject Type</div>
        </td>
        <td style="width: 77px; padding: 8px; border: 1px solid;">
            <div>Yes</div>
        </td>
        <td colspan="4" style="width: 631px; padding: 8px; border: 1px solid;">
            <div>Always</div>
        </td>
    </tr>
    <tr>
        <td rowspan="3" style="height: 92px; width: 111px; padding: 8px; border: 1px solid;">
            <div>Conditions</div>
            <div><br/></div>
            <div><br/></div>
        </td>
        <td rowspan="3" style="height: 92px; width: 77px; padding: 8px; border: 1px solid;">
            <div>No</div>
            <div><br/></div>
            <div><br/></div>
        </td>
        <td rowspan="1" style="width: 73px; padding: 8px; border: 1px solid;">
            <div>Target</div>
        </td>
        <td rowspan="1" style="width: 114px; padding: 8px; border: 1px solid;">
            <div><span style="font-family: &quot;Courier New&quot;;">can?</span></div>
        </td>
        <td rowspan="1" style="width: 156px; padding: 8px; border: 1px solid;">
            <div><span style="font-family: &quot;Courier New&quot;;">authorize!</span></div>
        </td>
        <td rowspan="1" style="width: 288px; padding: 8px; border: 1px solid;">
            <div><span style="font-family: &quot;Courier New&quot;;">accessible_by</span></div>
        </td>
    </tr>
    <tr>
        <td style="border: 1px solid; width: 73px; padding: 8px;">
            <div>Instance</div>
        </td>
        <td colspan="2" rowspan="1" style="width: 270px; padding: 8px; border: 1px solid;">
            <div><span style="color: rgb(41, 41, 41); --inversion-type-color: simple;">Matches:</span><br/>
            </div>
            <ul>
                <li>
                    <font
                            style="color: rgb(255, 38, 0); --inversion-type-color: simple;">Block</font><font
                            style="color: rgb(41, 41, 41); --inversion-type-color: simple;"> if defined
                        (evaluate to true/false)</font>
                </li>
            </ul>
            <ul>
                <li>
                    <font
                        style="color: rgb(255, 38, 0); --inversion-type-color: simple;">Hash</font><span
                        style="color: rgb(41, 41, 41); --inversion-type-color: simple;"> (if no block defined) Compares values of condition hash against those returned by calling the methods on the target with the same name as the corresponding condition hash key</span>
                </li>
            </ul>
            <div><span style="color: rgb(41, 41, 41); --inversion-type-color: simple;"><br/></span></div>
            <div><span style="color: rgb(41, 41, 41); --inversion-type-color: simple;">Ignores: </span></div>
            <ul>
                <li>
                    <span style="color: rgb(41, 41, 41); --inversion-type-color: simple;">Raw SQL or Scope (</span><span
                            style="color: rgb(41, 41, 41); --inversion-type-color: simple;">Throws error if block isn’t also defined)</span>
                </li>
            </ul>
        </td>
        <td style="width: 288px; padding: 8px; border: 1px solid;">
            <div><font style="color: rgb(110, 110, 110); --inversion-type-color: simple;">Not
                Applicable</font></div>
        </td>
    </tr>
    <tr>
        <td style="border: 1px solid; width: 73px; padding: 8px;">
            <div>Class</div>
        </td>
        <td colspan="2" style="width: 270px; padding: 8px; border: 1px solid;">
            <div><font style="color: rgb(110, 110, 110); --inversion-type-color: simple;">Ignored. Only ever
                matches on action ant target.</font></div>
            <div><font style="color: rgb(110, 110, 110); --inversion-type-color: simple;"><br/></font></div>
            <div><font style="color: rgb(110, 110, 110); --inversion-type-color: simple;">(Raw SQL or scope
                still throws error if block isn’t also defined)</font></div>
        </td>
        <td rowspan="1" style="width: 288px; padding: 8px; border: 1px solid;">
            <div><span style="color: rgb(41, 41, 41); --inversion-type-color:  simple;">Matches:</span></div>
            <ul>
                <li>
                    <span style="--inversion-type-color:  simple; color: rgb(41, 41, 41);"><font
                            style="color: rgb(255, 38, 0); --inversion-type-color: simple;">Raw SQL or Scope</font></span>:
                        Overrides other scopes you may have applied before calling  <span
                                style="font-family: &quot;Courier New&quot;;">accessible_by </span>- must use
                        as first scope
                </li>
                <li>
                    <font style="color: rgb(255, 38, 0); --inversion-type-color: simple;">Hash</font> (if
                        Raw SQL or Scope not defined) Constructs a<span
                                style="font-family: &quot;Courier New&quot;;"> LEFT JOIN </span>with them
                </li>
            </ul>
            <div><br/></div>
            <div>Ignores:</div>
            <ul>
                <li>
                    Block
                </li>
            </ul>
        </td>
    </tr>
    </tbody>
</table>


<h3>Usage examples</h3>

<table style="border-collapse: collapse; min-width: 100%;">
    <colgroup>
        <col style="width: 77px;"/>
        <col style="width: 310px;"/>
        <col style="width: 250px;"/>
        <col style="width: 179px;"/>
    </colgroup>
    <tbody>
    <tr>
        <td style="width: 77px; padding: 8px; border: 1px solid;">
            <div><br/></div>
        </td>
        <td style="width: 310px; padding: 8px; border: 1px solid;">
            <div>authorize!</div>
        </td>
        <td style="width: 250px; padding: 8px; border: 1px solid;">
            <div>can?</div>
        </td>
        <td style="width: 179px; padding: 8px; border: 1px solid;">
            <div>accessible_by</div>
        </td>
    </tr>
    <tr>
        <td style="width: 77px; padding: 8px; border: 1px solid;">
            <div>index</div>
        </td>
        <td style="width: 310px; padding: 8px; border: 1px solid;">
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>authorize! :index, Post</div>
                <div><br/></div>
                <div>@posts = Post.accessible_by(current_ability)</div>
            </div>
            <div/>
        </td>
        <td style="width: 250px; padding: 8px; border: 1px solid;">
            <div>Call on class (instance doesn’t make sense):</div>
            <div><br/></div>
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>- if can? :index, Post</div>
                <div>  = link_to ’New post’, new_post_path</div>
            </div>
            <div/>
            <div/>
        </td>
        <td style="width: 179px; padding: 8px; border: 1px solid;">
            <div>Always <font face="Courier New">authorize!</font> first </div>
            <div><br/></div>
            <div>Always use as the first scope you apply</div>
            <div><br/></div>
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>authorize! :index, Post</div>
                <div><br/></div>
                <div>@posts = Post.accessible_by(current_ability)</div>
            </div>
            <div/>
        </td>
    </tr>
    <tr>
        <td style="width: 77px; padding: 8px; border: 1px solid;">
            <div>show</div>
        </td>
        <td style="width: 310px; padding: 8px; border: 1px solid;">
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>@post = Post.find(params[:id])</div>
                <div><br/></div>
                <div>authorize! :show, @post</div>
            </div>
            <div/>
        </td>
        <td style="width: 250px; padding: 8px; border: 1px solid;">
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>- @post.each do |post|<br/></div>
                <div>  - if can? :show, post</div>
            </div>
            <div/>
        </td>
        <td style="width: 179px; padding: 8px; border: 1px solid;">
            <div>Can be used for scoping parent resources</div>
            <div><br/></div>
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>@subject = Subject.accessible_by(current_ability,:show)</div>
                <div><br/></div>
                <div>@article = @subject.articles.find(params[:id])</div>
                <div><br/></div>
                <div>authorize! :show, @article</div>
            </div>
            <div/>
        </td>
    </tr>
    <tr>
        <td style="width: 77px; padding: 8px; border: 1px solid;">
            <div>create</div>
        </td>
        <td style="width: 310px; padding: 8px; border: 1px solid;">
            <div>Assign attributes before validating (but save after)</div>
            <div><br/></div>
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>@post = Post.new(allowed_create_attributes)</div>
                <div><br/></div>
                <div>authorize! :create, @post</div>
            </div>
            <div/>
        </td>
        <td style="width: 250px; padding: 8px; border: 1px solid;">
            <div>Define new instance with known values:</div>
            <div><br/></div>
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>- if can?, :create, Post.new(subject: @subject, author: current_user)</div>
            </div>
            <div/>
        </td>
        <td style="width: 179px; padding: 8px; border: 1px solid;">
            <div>Not applicable</div>
        </td>
    </tr>
    <tr>
        <td style="width: 77px; padding: 8px; border: 1px solid;">
            <div>update</div>
        </td>
        <td style="width: 310px; padding: 8px; border: 1px solid;">
            <div>Check requirements for:</div>
            <div>* the current values of the resource using the hash<br/></div>
            <div>* new values using  the context<br/></div>
            <div><br/></div>
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>can :update, Post, user_id: user.id do |post, new_attributes|</div>
                <div>  # User is now allowed to update their own posts, but not change who the post is
                    by
                </div>
                <div>  post.user_id == user.id &amp;&amp; new_attributes[:user_id] == post.user_id</div>
                <div>end</div>
                <div><br/></div>
                <div>@post = Post.find(params[:id])</div>
                <div><br/></div>
                <div>authorize! :update, @post, allowed_update_params</div>
            </div>
            <div/>
        </td>
        <td style="width: 250px; padding: 8px; border: 1px solid;">
            <div>For generic update:</div>
            <div><br/></div>
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>- if can?, :update, @post</div>
                <div>  = link_to ‘Update’, edit_post_path(@post)</div>
            </div>
            <div/>
            <div><br/></div>
            <div>For sub-update:</div>
            <div><br/></div>
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>- if can?, :update, @post, { archived: true }</div>
                <div>  = link_to ‘Archive’, archive_post_path(@post)</div>
            </div>
            <div/>
            <div/>
        </td>
        <td style="width: 179px; padding: 8px; border: 1px solid;">
            <div>Useful for rendering a list of resources that the user can bulk update:</div>
            <div><br/></div>
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>@articles = Article.accessible_by(current_ability, :update)</div>
            </div>
            <div/>
        </td>
    </tr>
    <tr>
        <td style="width: 77px; padding: 8px; border: 1px solid;">
            <div>destroy</div>
        </td>
        <td style="width: 310px; padding: 8px; border: 1px solid;">
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>@post = Post.find(params[:id])</div>
                <div><br/></div>
                <div>authorize! :destroy, @post</div>
            </div>
            <div/>
        </td>
        <td style="width: 250px; padding: 8px; border: 1px solid;">
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>- if can?, :destroy, @post</div>
                <div>  = link_to ‘Delete’, post_path(@post), method: :delete</div>
            </div>
            <div/>
        </td>
        <td style="width: 179px; padding: 8px; border: 1px solid;">
            <div>Useful for rendering a list of resources that the user can bulk destroy:</div>
            <div><br/></div>
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>@articles = Article.accessible_by(current_ability, :destroy)</div>
            </div>
            <div/>
        </td>
    </tr>
    </tbody>
</table>


<h2>Handling failures</h2>

<p>For unauthorized requests, return <code>404</code> rather than <code>302</code> to avoid leaking information. However if you do want to render unauthorized:</p>

<p>Custom message to include in the exception thrown:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">authorize!</span> <span class="ss">:read</span><span class="p">,</span> <span class="no">Article</span><span class="p">,</span> <span class="ss">:message</span> <span class="o">=&gt;</span> <span class="s2">&quot;Unable to read this article.&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Raising exception manually:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">raise</span> <span class="no">CanCan</span><span class="o">::</span><span class="no">AccessDenied</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s2">&quot;Not authorized!&quot;</span><span class="p">,</span> <span class="ss">:read</span><span class="p">,</span> <span class="no">Article</span><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Rescuing:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">ApplicationController</span> <span class="o">&lt;</span> <span class="no">ActionController</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">rescue_from</span> <span class="no">CanCan</span><span class="o">::</span><span class="no">AccessDenied</span> <span class="k">do</span> <span class="o">|</span><span class="n">exception</span><span class="o">|</span>
</span><span class='line'>    <span class="n">respond_to</span> <span class="k">do</span> <span class="o">|</span><span class="nb">format</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">format</span><span class="o">.</span><span class="n">json</span> <span class="p">{</span> <span class="n">head</span> <span class="ss">:forbidden</span> <span class="p">}</span>
</span><span class='line'>      <span class="nb">format</span><span class="o">.</span><span class="n">html</span> <span class="p">{</span> <span class="n">redirect_to</span> <span class="n">main_app</span><span class="o">.</span><span class="n">root_url</span><span class="p">,</span> <span class="ss">:alert</span> <span class="o">=&gt;</span> <span class="n">exception</span><span class="o">.</span><span class="n">message</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">exception</span><span class="o">.</span><span class="n">action</span> <span class="c1"># =&gt; :read</span>
</span><span class='line'><span class="n">exception</span><span class="o">.</span><span class="n">subject</span> <span class="c1"># =&gt; Article</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Troubleshooting</h2>

<h3>Logging details of AccessDenied exceptions</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># in ApplicationController</span>
</span><span class='line'><span class="n">rescue_from</span> <span class="no">CanCan</span><span class="o">::</span><span class="no">AccessDenied</span> <span class="k">do</span> <span class="o">|</span><span class="n">exception</span><span class="o">|</span>
</span><span class='line'>  <span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span>
</span><span class='line'>    <span class="n">matching_rules</span> <span class="o">=</span> <span class="n">current_ability</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="ss">:relevant_rules_for_match</span><span class="p">,</span> <span class="n">exception</span><span class="o">.</span><span class="n">action</span><span class="p">,</span> <span class="n">exception</span><span class="o">.</span><span class="n">subject</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">if</span> <span class="n">matching_rules</span><span class="o">.</span><span class="n">any?</span>
</span><span class='line'>      <span class="n">describe_rules</span> <span class="o">=</span> <span class="n">matching_rules</span><span class="o">.</span><span class="n">map</span> <span class="p">{</span><span class="o">|</span><span class="n">rule</span><span class="o">|</span> <span class="p">{</span> <span class="ss">conditions</span><span class="p">:</span> <span class="n">rule</span><span class="o">.</span><span class="n">conditions</span><span class="p">,</span> <span class="ss">block</span><span class="p">:</span> <span class="n">rule</span><span class="o">.</span><span class="n">instance_variable_get</span><span class="p">(</span><span class="ss">:@block</span><span class="p">)</span> <span class="p">}</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&quot;CanCanCan::AccessDenied: User has ability to </span><span class="si">#{</span><span class="n">exception</span><span class="o">.</span><span class="n">action</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="p">\</span>
</span><span class='line'>                         <span class="s2">&quot;</span><span class="si">#{</span><span class="n">exception</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">, but failed to satisfy conditions: &quot;</span> <span class="p">\</span>
</span><span class='line'>                         <span class="s2">&quot;</span><span class="si">#{</span><span class="n">describe_rules</span><span class="o">.</span><span class="n">to_sentence</span><span class="p">(</span><span class="ss">two_words_connector</span><span class="p">:</span> <span class="s1">&#39; or &#39;</span><span class="p">,</span> <span class="ss">last_word_connector</span><span class="p">:</span> <span class="s1">&#39; or &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="no">Rails</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&quot;CanCanCan::AccessDenied: User does not have ability to </span><span class="si">#{</span><span class="n">exception</span><span class="o">.</span><span class="n">action</span><span class="si">}</span><span class="s2"> &quot;</span> <span class="p">\</span>
</span><span class='line'>                         <span class="s2">&quot;</span><span class="si">#{</span><span class="n">exception</span><span class="o">.</span><span class="n">subject</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Order code is executed</h3>

<ul>
<li>Request is made and assigned to a controller</li>
<li>Controller instance calls current_ability method</li>
<li><code>current_ability</code> instantiates an instance of <code>CanCan::Ability</code> class (so your <code>ability.rb</code> file’s initialize method is called)</li>
</ul>


<p>Case: For <code>authorize!</code> or <code>can?</code></p>

<ul>
<li>Controller makes first call to <code>authorize!</code> or <code>can?</code> (which calls <code>can?</code> on your <code>current_ability</code> instance)</li>
<li>Matching rules are found based on the subject’s class and action</li>
<li>If the subject is a class, this is where the logic stops (and we only check for a matching action)</li>
<li>If the subject is an instance

<ul>
<li>If a block is defined, its evaluated, and logic ends</li>
<li>If a hash is defined, its values are matched against the subject’s attributes</li>
</ul>
</li>
</ul>


<p>Case: For <code>accessible_by</code></p>

<ul>
<li>Controller calls <code>model_adaptor</code> on your <code>current_ability</code> and other methods to find matching rules based on the subject’s class and action</li>
<li>Returns a <code>ActiveRecord::Relation</code> for the subject model class with the raw SQL or scope if one has bee defined, otherwise a <code>LEFT JOIN</code> with the attributes from the hash</li>
</ul>


<table style="border-collapse: collapse; min-width: 100%;">
    <colgroup>
        <col style="width: 107px;"/>
        <col style="width: 375px;"/>
        <col style="width: 333px;"/>
    </colgroup>
    <tbody>
    <tr>
        <td rowspan="1" style="width: 107px; padding: 8px; border: 1px solid;">
            <div>Checking</div>
        </td>
        <td rowspan="1" style="width: 375px; padding: 8px; border: 1px solid;">
            <div><span style="font-family: &quot;Courier New&quot;;">authorize!</span> or <span
                    style="font-family: &quot;Courier New&quot;;">can?</span></div>
        </td>
        <td rowspan="1" style="width: 333px; padding: 8px; border: 1px solid;">
            <div><span style="font-family: &quot;Courier New&quot;;">accessible_by</span></div>
        </td>
    </tr>
    <tr>
        <td rowspan="1" style="width: 107px; padding: 8px; border: 1px solid;">
            <div>Current user and/or ability.rb logic</div>
        </td>
        <td colspan="2" rowspan="1" style="width: 708px; padding: 8px; border: 1px solid;">
            <div>Place logging statements in your <span style="font-family: &quot;Courier New&quot;;">ability.rb</span>
                file
            </div>
        </td>
    </tr>
    <tr>
        <td rowspan="1" style="width: 107px; padding: 8px; border: 1px solid;">
            <div>Action and Subject</div>
        </td>
        <td rowspan="1" style="width: 375px; padding: 8px; border: 1px solid;">
            <div>Rescue failed <span style="font-family: &quot;Courier New&quot;;">authorize!</span> in
                controller: 
            </div>
            <div><br clear="none"/></div>
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div><span style="color: rgb(255, 38, 0); --inversion-type-color: simple;">rescue_from CanCan::AccessDenied </span>do
                    |exception|
                </div>
                <div>  p exception.subject</div>
                <div>  p exception.action</div>
                <div>end</div>
            </div>
            <div><br clear="none"/></div>
            <div><span style="font-family: &quot;Helvetica Neue&quot;;">Rails console:</span></div>
            <div><br clear="none"/></div>
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>user = User.create!</div>
                <div>ability = <span style="color: rgb(255, 38, 0); --inversion-type-color: simple;">Ability.new(user)</span>
                </div>
                <div>ability.<span style="color: rgb(255, 38, 0); --inversion-type-color: simple;">can?</span>(:destroy,
                    Project.new(user: user)<span
                            style="color: rgb(255, 38, 0); --inversion-type-color: simple;">)</span></div>
            </div>
            <div><br clear="none"/></div>
            <div><span style="font-family: &quot;Helvetica Neue&quot;;">See if there is a matching rule for class and action:</span>
            </div>
            <div><br clear="none"/></div>
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div><span style="color: rgb(255, 38, 0); --inversion-type-color: simple;">current_ability.send(:relevant_rules_for_match, action, class_or_instance)</span>
                </div>
            </div>
            <div><br clear="none"/></div>
            <div><span
                    style="font-family: &quot;Helvetica Neue&quot;;">See if the rule’s conditions match:</span>
            </div>
            <ul>
                <li>
                    <span style="-en-paragraph:true;">If not, use techniques below depending on how you’re defining your matching rule </span>
                </li>
            </ul>
            <div><br clear="none"/></div>
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>current_ability.send(:relevant_rules_for_match, action, class_or_instance).first<span
                        style="color: rgb(255, 38, 0); --inversion-type-color: simple;">.matches_conditions?(action, subject, {})</span>
                </div>
            </div>
            <div><br clear="none"/></div>
        </td>
        <td rowspan="1" style="width: 333px; padding: 8px; border: 1px solid;">
            <div>Make sure:</div>
            <ul>
                <li>
                    Check class you’re calling accessible_by on and the arguments you’re passing it
                </li>
            </ul>
            <div><br clear="none"/></div>
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div><span
                        style="font-size: 12px; font-family: Monaco; color: rgb(255, 38, 0); --inversion-type-color: simple;">current_ability.can?(:index, ModelClass)</span>
                </div>
            </div>
        </td>
    </tr>
    <tr>
        <td rowspan="1" style="width: 107px; padding: 8px; border: 1px solid;">
            <div><span
                    style="--inversion-type-color:  simple; color: rgb(20, 20, 20);">Raw SQL or scope</span>
            </div>
        </td>
        <td rowspan="1" style="width: 375px; padding: 8px; border: 1px solid;">
            <div><span
                    style="--inversion-type-color:  simple; color: rgb(110, 110, 110);">Not applicable</span>
            </div>
            <div><br clear="none"/></div>
        </td>
        <td rowspan="1" style="width: 333px; padding: 8px; border: 1px solid;">
            <div><span
                    style="--inversion-type-color:  simple; color: rgb(20, 20, 20); font-family: &quot;Helvetica Neue&quot;;">See SQL (works for hashes too):</span>
            </div>
            <div><br clear="none"/></div>
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>Project.accessible_by(ability)<span
                        style="color: rgb(255, 38, 0); --inversion-type-color: simple;">.to_sql</span></div>
            </div>
        </td>
    </tr>
    <tr>
        <td rowspan="1" style="width: 107px; padding: 8px; border: 1px solid;">
            <div>Hash</div>
        </td>
        <td rowspan="1" style="width: 375px; padding: 8px; border: 1px solid;">
            <div>See the hash that’s used to match the instance’s values:</div>
            <div><br clear="none"/></div>
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>current_ability.model_adapter(exception.subject, exception.action)<span
                        style="color: rgb(255, 38, 0); --inversion-type-color: simple;">.conditions</span>
                </div>
            </div>
            <div><br clear="none"/></div>
        </td>
        <td rowspan="1" style="width: 333px; padding: 8px; border: 1px solid;">
            <div><span style="font-family: &quot;Helvetica Neue&quot;;">See hash passed to where:</span></div>
            <div><br clear="none"/></div>
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>current_ability<span style="color: rgb(255, 38, 0); --inversion-type-color: simple;">.model_adapter(TargetClass, :read).conditions</span>
                </div>
            </div>
            <div><br clear="none"/></div>
            <div>Test query by performing the same <font face="Courier New">LEFT JOIN</font> CanCanCan does:
            </div>
            <div><br clear="none"/></div>
            <div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.15);-en-codeblock:true;">
                <div>User.where(id: current_user.id)<font
                        style="color: rgb(255, 38, 0); --inversion-type-color: simple;">.joins(</font>current_ability.model_adapter(TargetClass,
                    :read).conditions<font
                            style="color: rgb(255, 38, 0); --inversion-type-color: simple;">)</font></div>
            </div>
        </td>
    </tr>
    <tr>
        <td rowspan="1" style="width: 107px; padding: 8px; border: 1px solid;">
            <div>Block</div>
        </td>
        <td rowspan="1" style="width: 375px; padding: 8px; border: 1px solid;">
            <div><span style="font-family: &quot;Helvetica Neue&quot;;">Place logging or debugging statement in the block and check the result that’s returned</span>
            </div>
        </td>
        <td rowspan="1" style="width: 333px; padding: 8px; border: 1px solid;">
            <div><span
                    style="--inversion-type-color:  simple; color: rgb(110, 110, 110);">Not applicable</span>
            </div>
        </td>
    </tr>
    </tbody>
</table>


<h3>Common exceptions</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">undefined</span> <span class="nb">method</span> <span class="sb">`klass&#39; for nil:NilClass</span>
</span></code></pre></td></tr></table></div></figure>


<p></p>

<p>Occurs when you&rsquo;ve defined an association name incorrectly in a condition hash.</p>


        <hr class="divider-short"/>

        
        <section>
          <h1>Comments</h1>
          <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
        </section>
        
      </div>
    </div>
  </div>
</article>

<hr class="divider-short"/>

<div class="archive-link">
  <div class="container">
    <div class="row">
      <div class="col-md-8 col-md-offset-2">
        
          <a class="pull-left" href="/blog/2016/08/19/emojis-are-the-solution-to-useless-commit-messages/" title="Previous Post: Emojis are the solution to useless commit messages">&laquo; Previous: Emojis are the solution to useless commit messages</a>
        

        
      </div>
    </div>
  </div>
</div>

    <footer id="footer" class="her-row">
  <div class="container">
    <div class="row">
      <div class="col-md-1">
  <a href="/"><h4>Home</h4></a>
</div>

<div class="col-md-2">
  <div class="social-icon-list">
    

    
    <a href="https://github.com/greena13"><img src="/images/glyphicons_social_21_github.png"/></a>
    

    

    
  </div>
</div>

<div class="pull-right">
  <h4>Powered by <a href="http://octopress.org/">Octopress</a>. Designed by <a href="http://AdrianArtiles.com">Adrian Artiles</a>.</h4>
</div>


    </div>
  </div>
</footer>

    
      

<script type="text/javascript">
      var disqus_shortname = 'keyshiftincmd';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://greena13.github.io/blog/2019/07/12/cancancan-cheatsheet/';
        var disqus_url = 'http://greena13.github.io/blog/2019/07/12/cancancan-cheatsheet/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>


    
  </body>
</html>
